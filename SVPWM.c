#include "SVPWM.h"
#include "3PhaseInverter.h"

bit PhaseU_Target;
bit PhaseV_Target;
bit PhaseW_Target;

unsigned int T07,T1,T2,PWMB,PWMM,PWMS;

bit SVPFirstHalfSector;

unsigned char code SVPList1[]={0,
6,12,19,25,31,
37,43,50,56,62,
68,74,80,86,92,
97,103,109,114,120,
125,131,136,141,146,
151,156,161,166,171,
175,180,184,188,192,
197,200,204,208,211,
215,218,219,216,212,
209,205,201,197,193,
189,185,181,176,172,
167,162,158,153,148,
142,137,132,127,121,
116,110,104,99,93,
87,81,75,69,63,
57,51,45,39,33,
26,20,14,8,1,
5,11,17,23,30,
36,42,48,54,60,
66,72,78,84,90,
96,102,107,113,119,
124,129,135,140,145,
150,155,160,165,170,
174,179,183,187,192,
196,199,203,207,211,
214,217,220,216,213,
210,206,202,198,194,
190,186,182,177,173,
168,164,159,154,149,
144,139,133,128,122,
117,111,106,100,94,
88,83,77,71,65,
59,53,46,40,34,
28,22,15,9,3,
3,10,16,22,28,
34,41,47,53,59,
65,71,77,83,89,
95,100,106,112,117,
123,128,134,139,144,
149,154,159,164,169,
173,178,182,186,191,
195,199,202,206,210,
213,216,220,217,214,
210,207,203,199,195,
191,187,183,178,174,
169,165,160,155,150,
145,140,134,129,124,
118,113,107,101,96,
90,84,78,72,66,
60,54,48,42,36,
29,23,17,11,4,
};

unsigned char code SVPList2[]={220,
223,226,229,231,234,
236,238,241,242,244,
246,247,249,250,251,
252,253,253,254,254,
254,254,254,253,253,
252,252,251,249,248,
247,245,244,242,240,
238,235,233,230,228,
225,222,221,224,227,
230,232,235,237,239,
241,243,245,246,248,
249,250,251,252,253,
253,254,254,254,254,
254,253,253,252,251,
250,249,248,246,245,
243,241,239,237,234,
232,229,227,224,221,
222,225,228,231,233,
236,238,240,242,244,
246,247,248,250,251,
252,252,253,254,254,
254,254,254,254,253,
252,252,251,250,249,
247,246,244,242,240,
238,236,234,231,228,
226,223,220,223,226,
229,232,234,237,239,
241,243,245,246,248,
249,250,251,252,253,
253,254,254,254,254,
254,253,253,252,251,
250,249,248,247,245,
243,241,239,237,235,
233,230,227,224,221,
222,225,227,230,233,
235,237,240,242,243,
245,247,248,249,250,
251,252,253,253,254,
254,254,254,254,253,
253,252,251,250,249,
248,246,244,243,241,
239,236,234,232,229,
226,223,220,223,226,
228,231,234,236,238,
240,242,244,246,247,
249,250,251,252,253,
253,254,254,254,254,
254,253,253,252,252,
251,250,248,247,245,
244,242,240,238,236,
233,231,228,225,222,

};


unsigned char xdata T1Array[]={0,
6,12,19,25,31,
37,43,50,56,62,
68,74,80,86,92,
97,103,109,114,120,
125,131,136,141,146,
151,156,161,166,171,
175,180,184,188,192,
197,200,204,208,211,
215,218,219,216,212,
209,205,201,197,193,
189,185,181,176,172,
167,162,158,153,148,
142,137,132,127,121,
116,110,104,99,93,
87,81,75,69,63,
57,51,45,39,33,
26,20,14,8,1,
5,11,17,23,30,
36,42,48,54,60,
66,72,78,84,90,
96,102,107,113,119,
124,129,135,140,145,
150,155,160,165,170,
174,179,183,187,192,
196,199,203,207,211,
214,217,220,216,213,
210,206,202,198,194,
190,186,182,177,173,
168,164,159,154,149,
144,139,133,128,122,
117,111,106,100,94,
88,83,77,71,65,
59,53,46,40,34,
28,22,15,9,3,
3,10,16,22,28,
34,41,47,53,59,
65,71,77,83,89,
95,100,106,112,117,
123,128,134,139,144,
149,154,159,164,169,
173,178,182,186,191,
195,199,202,206,210,
213,216,220,217,214,
210,207,203,199,195,
191,187,183,178,174,
169,165,160,155,150,
145,140,134,129,124,
118,113,107,101,96,
90,84,78,72,66,
60,54,48,42,36,
29,23,17,11,4};

unsigned char xdata T2Array[]={220,
223,226,229,231,234,
236,238,241,242,244,
246,247,249,250,251,
252,253,253,254,254,
254,254,254,253,253,
252,252,251,249,248,
247,245,244,242,240,
238,235,233,230,228,
225,222,221,224,227,
230,232,235,237,239,
241,243,245,246,248,
249,250,251,252,253,
253,254,254,254,254,
254,253,253,252,251,
250,249,248,246,245,
243,241,239,237,234,
232,229,227,224,221,
222,225,228,231,233,
236,238,240,242,244,
246,247,248,250,251,
252,252,253,254,254,
254,254,254,254,253,
252,252,251,250,249,
247,246,244,242,240,
238,236,234,231,228,
226,223,220,223,226,
229,232,234,237,239,
241,243,245,246,248,
249,250,251,252,253,
253,254,254,254,254,
254,253,253,252,251,
250,249,248,247,245,
243,241,239,237,235,
233,230,227,224,221,
222,225,227,230,233,
235,237,240,242,243,
245,247,248,249,250,
251,252,253,253,254,
254,254,254,254,253,
253,252,251,250,249,
248,246,244,243,241,
239,236,234,232,229,
226,223,220,223,226,
228,231,234,236,238,
240,242,244,246,247,
249,250,251,252,253,
253,254,254,254,254,
254,253,253,252,252,
251,250,248,247,245,
244,242,240,238,236,
233,231,228,225,222,
};

void SetSVPWMValue(unsigned char length)
{
	unsigned char i = 0;
	for(i = 0;i < 255;i += 1)
	{	
		T1Array[i] = ((int)SVPList1[i] * length) >> 8;
		T2Array[i] = ((int)SVPList2[i] * length) >> 8;
	}
}

<<<<<<< Updated upstream
void CalculateInverterVectorsWidth_Polar(unsigned char deg) using 1
=======
void CalculateInverterVectorsWidth_Polar(unsigned char deg) using 2
>>>>>>> Stashed changes
{
	T1 = T1Array[deg];
	T2 = T2Array[deg];
	
//	T1 = ((int)SVPList1[deg] * 50) >> 8;
//	T2 = ((int)SVPList2[deg] * 50) >> 8;
	
	T07 = (255-T2) >> 1;	
	PWMS = T07;
	PWMM = T07 + T1;
	PWMB = T07 + T2;
	
	EA = 0;
	
	if((deg < 43))
	{
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = T07;
//		if(T1 > 30)	
//			PWMINTC=0X15;
//		else if(T2 - T1 > 30)
//			PWMINTC=0X13;
//		else	
//			PWMINTC=0X11;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
		PWM2L = PWMM;
		PWM0L = PWMB;
	}
	else if((deg < 85))
	{
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = T07;
//		if(T1 > 30)	
//			PWMINTC=0X15;
//		else if(T2 - T1 > 30)		
//			PWMINTC=0X11;
//		else	
//			PWMINTC=0X13;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
		PWM0L = PWMM;
		PWM2L = PWMB;
	}
	else if((deg < 128))
	{
		PWM0L = T07;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = PWMM;
//		if(T1 > 30)	
//			PWMINTC=0X11;
//		else	if(T2 - T1 > 30)	
//			PWMINTC=0X15;
//		else	
//			PWMINTC=0X13;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
		PWM2L = PWMB;
	}
	else if((deg < 171))
	{
		PWM0L = T07;
		PWM2L = PWMM;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = PWMB;
//		if(T1 > 30)	
//			PWMINTC=0X11;
//		else	if(T2 - T1 > 30)	
//			PWMINTC=0X13;
//		else	
//			PWMINTC=0X15;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
	}
	else if((deg < 213))
	{
		PWM2L = T07;
		PWM0L = PWMM;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = PWMB;
//		if(T1 > 30)	
//			PWMINTC=0X13;
//		else	if(T2 - T1 > 30)	
//			PWMINTC=0X11;
//		else	
//			PWMINTC=0X15;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
	}
	else	if((deg < 255))
	{
		PWM2L = T07;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = PWMM;
//		if(T1 > 30)	
//			PWMINTC=0X11;
//		else	if(T2 - T1 > 30)	
//			PWMINTC=0X15;
//		else	
//			PWMINTC=0X11;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
		PWM0L = PWMB;
	}
	PMEN = 0X00;
	PWMCON1 |= 0X10;
	PWMCON0 |= 0X40;
	EA = 1;
}





