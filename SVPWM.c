#include "SVPWM.h"
#include "3PhaseInverter.h"

bit PhaseU_Target;
bit PhaseV_Target;
bit PhaseW_Target;

unsigned int T07,T1,T2,PWMB,PWMM,PWMS;

bit SVPFirstHalfSector;

unsigned int code T1Array[]={0,
4,9,13,18,22,
27,31,35,40,44,
48,53,57,61,66,
70,74,78,83,87,
91,95,99,103,107,
111,115,119,123,127,
131,135,138,142,146,
149,153,156,160,163,
167,170,173,176,180,
183,186,189,192,195,
197,200,203,205,208,
211,213,215,218,220,
218,215,213,211,208,
205,203,200,197,195,
192,189,186,183,180,
176,173,170,167,163,
160,156,153,149,146,
142,138,135,131,127,
123,119,115,111,107,
103,99,95,91,87,
83,78,74,70,66,
61,57,53,48,44,
40,35,31,27,22,
18,13,9,4,0,
4,9,13,18,22,
27,31,35,40,44,
48,53,57,61,66,
70,74,78,83,87,
91,95,99,103,107,
111,115,119,123,127,
131,135,138,142,146,
149,153,156,160,163,
167,170,173,176,180,
183,186,189,192,195,
197,200,203,205,208,
211,213,215,218,220,
218,215,213,211,208,
205,203,200,197,195,
192,189,186,183,180,
176,173,170,167,163,
160,156,153,149,146,
142,138,135,131,127,
123,119,115,111,107,
103,99,95,91,87,
83,78,74,70,66,
61,57,53,48,44,
40,35,31,27,22,
18,13,9,4,0,
4,9,13,18,22,
27,31,35,40,44,
48,53,57,61,66,
70,74,78,83,87,
91,95,99,103,107,
111,115,119,123,127,
131,135,138,142,146,
149,153,156,160,163,
167,170,173,176,180,
183,186,189,192,195,
197,200,203,205,208,
211,213,215,218,220,
218,215,213,211,208,
205,203,200,197,195,
192,189,186,183,180,
176,173,170,167,163,
160,156,153,149,146,
142,138,135,131,127,
123,119,115,111,107,
103,99,95,91,87,
83,78,74,70,66,
61,57,53,48,44,
40,35,31,27,22,
18,13,9,4,0,

};

unsigned int code T2Array[]={220,
222,224,226,228,230,
232,234,236,237,239,
240,242,243,244,245,
246,247,248,249,250,
251,252,252,253,253,
253,254,254,254,254,
254,254,254,253,253,
253,252,252,251,250,
249,248,247,246,245,
244,243,242,240,239,
237,236,234,232,230,
228,226,224,222,220,
222,224,226,228,230,
232,234,236,237,239,
240,242,243,244,245,
246,247,248,249,250,
251,252,252,253,253,
253,254,254,254,254,
254,254,254,253,253,
253,252,252,251,250,
249,248,247,246,245,
244,243,242,240,239,
237,236,234,232,230,
228,226,224,222,220,
222,224,226,228,230,
232,234,236,237,239,
240,242,243,244,245,
246,247,248,249,250,
251,252,252,253,253,
253,254,254,254,254,
254,254,254,253,253,
253,252,252,251,250,
249,248,247,246,245,
244,243,242,240,239,
237,236,234,232,230,
228,226,224,222,220,
222,224,226,228,230,
232,234,236,237,239,
240,242,243,244,245,
246,247,248,249,250,
251,252,252,253,253,
253,254,254,254,254,
254,254,254,253,253,
253,252,252,251,250,
249,248,247,246,245,
244,243,242,240,239,
237,236,234,232,230,
228,226,224,222,220,
222,224,226,228,230,
232,234,236,237,239,
240,242,243,244,245,
246,247,248,249,250,
251,252,252,253,253,
253,254,254,254,254,
254,254,254,253,253,
253,252,252,251,250,
249,248,247,246,245,
244,243,242,240,239,
237,236,234,232,230,
228,226,224,222,220,
222,224,226,228,230,
232,234,236,237,239,
240,242,243,244,245,
246,247,248,249,250,
251,252,252,253,253,
253,254,254,254,254,
254,254,254,253,253,
253,252,252,251,250,
249,248,247,246,245,
244,243,242,240,239,
237,236,234,232,230,
228,226,224,222,220,


};


void CalculateInverterVectorsWidth_Polar(unsigned int deg, unsigned char length)  using 1
{
	T1 = (T1Array[deg] * length) >> 8;
	T2 = (T2Array[deg] * length) >> 8;
	T07 = (255-T2) >> 1;
	
	PWMS = T07;
	PWMM = T07 + T1;
	PWMB = T07 + T2;
	
	EA = 0;
	
	if((deg < 60))
	{
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = T07;
		if(T1 > 30)	
			PWMINTC=0X15;
		else if(T2 - T1 > 30)
			PWMINTC=0X13;
		else	
			PWMINTC=0X11;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
		PWM2L = PWMM;
		PWM0L = PWMB;
	}
	else if((deg < 120))
	{
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = T07;
		if(T1 > 30)	
			PWMINTC=0X15;
		else if(T2 - T1 > 30)		
			PWMINTC=0X11;
		else	
			PWMINTC=0X13;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
		PWM0L = PWMM;
		PWM2L = PWMB;
	}
	else if((deg < 180))
	{
		PWM0L = T07;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = PWMM;
		if(T1 > 30)	
			PWMINTC=0X11;
		else	if(T2 - T1 > 30)	
			PWMINTC=0X15;
		else	
			PWMINTC=0X13;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
		PWM2L = PWMB;
	}
	else if((deg < 240))
	{
		PWM0L = T07;
		PWM2L = PWMM;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = PWMB;
		if(T1 > 30)	
			PWMINTC=0X11;
		else	if(T2 - T1 > 30)	
			PWMINTC=0X13;
		else	
			PWMINTC=0X15;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
	}
	else if((deg < 300))
	{
		PWM2L = T07;
		PWM0L = PWMM;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = PWMB;
		if(T1 > 30)	
			PWMINTC=0X13;
		else	if(T2 - T1 > 30)	
			PWMINTC=0X11;
		else	
			PWMINTC=0X15;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
	}
	else if((deg < 360))
	{
		PWM2L = T07;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 1;
		PWM4L = PWMM;
		if(T1 > 30)	
			PWMINTC=0X11;
		else	if(T2 - T1 > 30)	
			PWMINTC=0X15;
		else	
			PWMINTC=0X11;
		TA = 0X0AA;
		TA = 0X55;
		SFRS = 0;
		PWM0L = PWMB;
	}
	PMEN = 0X00;
	PWMCON1 |= 0X10;
	PWMCON0 |= 0X40;
	EA = 1;
}





