C51 COMPILER V9.59.0.0   BLDC_WITH_HALL                                                    12/23/2018 18:24:00 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE BLDC_WITH_HALL
OBJECT MODULE PLACED IN .\Objects\BLDC with Hall.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE BLDC with Hall.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Lis
                    -tings\BLDC with Hall.lst) TABS(2) OBJECT(.\Objects\BLDC with Hall.obj)

line level    source

   1          #include <N76E003.h>
   2          #include "BLDC with Hall.h"
   3          #include "3PhaseInverter.h"
   4          
   5          bit BLDCReverse = 1;
   6          bit HA,HB,HC;
   7          
   8          unsigned char BLDCSpeed;
   9          
  10          void SetBLDCDirPWM(unsigned char pwm, bit dir)
  11          {
  12   1        BLDCReverse = dir;
  13   1        BLDCSpeed = pwm;
  14   1      }
  15          
  16          void UpdateHall() using 2
  17          { 
  18   1        HA = HAPort;
  19   1        HB = HBPort;
  20   1        HC = HCPort;
  21   1      }
  22          
  23          void HallGpioInit()
  24          {
  25   1        P0M1 &= 0XE7;
  26   1        P0M2 &= 0XE7;
  27   1        P1M1 &= 0XEB;
  28   1        P1M2 &= 0XEB; 
  29   1        TA = 0X0AA;
  30   1        TA = 0X55;
  31   1        SFRS = 1;
  32   1        P1S |= 0X18;
  33   1        P0S |= 0X08;
  34   1        TA = 0X0AA;
  35   1        TA = 0X55;
  36   1        SFRS = 0;
  37   1        HAPort = 1;
  38   1        HBPort = 1;
  39   1        HCPort = 1;
  40   1      }
  41          /*
  42          unsigned char DetermineCurrentElecCycle(bit reverse)
  43          {
  44            if(HA && !HB && HC)
  45              if(reverse)
  46                return 4;
  47              else
  48                return 1;
  49              
  50            if(HA && !HB && !HC)
  51              if(reverse)
  52                return 5;
  53              else
  54                return 2;
C51 COMPILER V9.59.0.0   BLDC_WITH_HALL                                                    12/23/2018 18:24:00 PAGE 2   

  55              
  56            if(HA && HB && !HC)
  57              if(reverse)
  58                return 6;
  59              else
  60                return 3;
  61              
  62            if(!HA && HB && !HC)
  63              if(reverse)
  64                return 1;
  65              else
  66                return 4;
  67              
  68            if(!HA && HB && HC)
  69              if(reverse)
  70                return 2;
  71              else
  72                return 5;
  73              
  74            if(!HA && !HB && HC)
  75              if(reverse)
  76                return 3;
  77              else
  78                return 6;
  79            return 0;
  80          }
  81          */
  82          
  83          unsigned char DetermineCurrentElecCycle(bit reverse) using 1
  84          { 
  85   1        if(HAPort)
  86   1        {
  87   2          if(HBPort)
  88   2          {
  89   3            if(HCPort)
  90   3            {
  91   4              if(reverse)
  92   4                return 5;
  93   4              else
  94   4                return 3;   
  95   4            }
  96   3            else
  97   3            {
  98   4              if(reverse)
  99   4                return 4;
 100   4              else
 101   4                return 2;
 102   4            }
 103   3          }
 104   2          else
 105   2          {
 106   3            if(HCPort)
 107   3            {
 108   4            }
 109   3            else
 110   3            {
 111   4              if(reverse)
 112   4                return 3;
 113   4              else
 114   4                return 1;
 115   4            }
 116   3          }
C51 COMPILER V9.59.0.0   BLDC_WITH_HALL                                                    12/23/2018 18:24:00 PAGE 3   

 117   2        }
 118   1        else
 119   1        {
 120   2          if(HBPort)
 121   2          {
 122   3            if(HCPort)
 123   3            {
 124   4              if(reverse)
 125   4                return 6;
 126   4              else
 127   4                return 4;
 128   4            }
 129   3          }
 130   2          else
 131   2          {
 132   3            if(HCPort)
 133   3            {
 134   4              if(reverse)
 135   4                return 1;
 136   4              else
 137   4                return 5;     
 138   4            }
 139   3            else
 140   3            {
 141   4              if(reverse)
 142   4                return 2;
 143   4              else
 144   4                return 6; 
 145   4            }
 146   3          }
 147   2        }
 148   1        return 0;
 149   1      }
 150          
 151          void UpdateBLDCInverter(unsigned char eleccycle) using 1
 152          {
 153   1        EA = 0;
 154   1        switch(eleccycle)
 155   1        {
 156   2          case 1: {     
 157   3            PMEN = 0X30;
 158   3            PWM0L = BLDCSpeed;
 159   3            PWM2L = 0;
 160   3            PWMCON0 |= 0X40;
 161   3            TA = 0X0AA;
 162   3            TA = 0X55;
 163   3            SFRS = 1;
 164   3            PWMINTC=0X10;
 165   3            TA = 0X0AA;
 166   3            TA = 0X55;
 167   3            SFRS = 0;
 168   3            break;
 169   3          }
 170   2          case 2: {
 171   3            PMEN = 0X0C;
 172   3            PWM0L = BLDCSpeed;
 173   3            TA = 0X0AA;
 174   3            TA = 0X55;
 175   3            SFRS = 1;
 176   3            PWM4L = 0;
 177   3            PWMINTC=0X10;
 178   3            TA = 0X0AA;
C51 COMPILER V9.59.0.0   BLDC_WITH_HALL                                                    12/23/2018 18:24:00 PAGE 4   

 179   3            TA = 0X55;
 180   3            SFRS = 0;
 181   3            PWMCON0 |= 0X40;
 182   3            break;
 183   3          }
 184   2          case 3: {
 185   3            PMEN = 0X03;
 186   3            PWM2L = BLDCSpeed;
 187   3            TA = 0X0AA;
 188   3            TA = 0X55;
 189   3            SFRS = 1;
 190   3            PWM4L = 0;
 191   3            PWMINTC=0X12;
 192   3            TA = 0X0AA;
 193   3            TA = 0X55;
 194   3            SFRS = 0;
 195   3            PWMCON0 |= 0X40;
 196   3            break;
 197   3          }
 198   2          case 4: {     
 199   3            PMEN = 0X30;
 200   3            PWM2L = BLDCSpeed;
 201   3            TA = 0X0AA;
 202   3            TA = 0X55;
 203   3            SFRS = 1;
 204   3            PWMINTC=0X12;
 205   3            TA = 0X0AA;
 206   3            TA = 0X55;
 207   3            SFRS = 0;
 208   3            PWM0L = 0;
 209   3            PWMCON0 |= 0X40;
 210   3            break;
 211   3          }
 212   2          case 5: {
 213   3            PMEN = 0X0C;
 214   3            TA = 0X0AA;
 215   3            TA = 0X55;
 216   3            SFRS = 1;
 217   3            PWM4L = BLDCSpeed;
 218   3            PWMINTC=0X14;
 219   3            TA = 0X0AA;
 220   3            TA = 0X55;
 221   3            SFRS = 0;
 222   3            PWM0L = 0;
 223   3            PWMCON0 |= 0X40;
 224   3            break;
 225   3          }
 226   2          case 6: {
 227   3            PMEN = 0X03;
 228   3            TA = 0X0AA;
 229   3            TA = 0X55;
 230   3            SFRS = 1;
 231   3            PWM4L = BLDCSpeed;    
 232   3            PWMINTC=0X14;
 233   3            TA = 0X0AA;
 234   3            TA = 0X55;
 235   3            SFRS = 0;
 236   3            PWM2L = 0;
 237   3            PWMCON0 |= 0X40;
 238   3            break;
 239   3          }
 240   2          case 0:
C51 COMPILER V9.59.0.0   BLDC_WITH_HALL                                                    12/23/2018 18:24:00 PAGE 5   

 241   2            break;
 242   2        }
 243   1        EA = 1;
 244   1      } 
 245          
 246          void BLDCTimerEventHandler() using 1
 247          { 
 248   1        UpdateBLDCInverter(DetermineCurrentElecCycle(BLDCReverse));
 249   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    404    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      1    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      4       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
