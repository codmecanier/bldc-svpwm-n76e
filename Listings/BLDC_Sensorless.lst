C51 COMPILER V9.59.0.0   BLDC_SENSORLESS                                                   02/23/2019 21:02:51 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE BLDC_SENSORLESS
OBJECT MODULE PLACED IN .\Objects\BLDC_Sensorless.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE BLDC_Sensorless.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\BLDC_Sensorless.lst) TABS(2) OBJECT(.\Objects\BLDC_Sensorless.obj)

line level    source

   1          #include <N76E003.h>
   2          #include <BLDC_Sensorless.h>
   3          
   4          #define MagDecayPulseDct 2
   5          #define MagDecayPulseCnt 4
   6          unsigned int DCBUS_Voltage = 0;
   7          
   8          unsigned int data Phase_UVW_Voltage_ADC_Value[3];
   9          
  10          const unsigned char BEMF_DCT_Params[6][3] = {
  11            {0,2,0},
  12            {0,1,1},
  13            {1,0,0},
  14            {1,2,1},
  15            {2,1,0},
  16            {2,0,1},
  17          };
  18          
  19          #define DC_CH 0
  20          #define BEMF_CH 1
  21          #define SLOPE 2
  22          
  23          unsigned char data PreviousBEMF_CH;
  24          unsigned char data PrevoiusBEMF_Value;
  25          unsigned char data BEMF_Slope_Count;
  26          
  27          void Set_Phase_U_Voltage_ADC_Value(unsigned int i) using 1
  28          {
  29   1        Phase_UVW_Voltage_ADC_Value[0] = i;
  30   1      }
  31          void Set_Phase_V_Voltage_ADC_Value(unsigned int i) using 1
  32          {
  33   1        Phase_UVW_Voltage_ADC_Value[1] = i;
  34   1      }
  35          void Set_Phase_W_Voltage_ADC_Value(unsigned int i) using 1
  36          {
  37   1        Phase_UVW_Voltage_ADC_Value[2] = i;
  38   1      }
  39          
  40          void Start_BEMF_Detect_ADC(unsigned char eleccycle, unsigned char times) using 1
  41          {
  42   1        ADCCON1 = 0X01;////
  43   1        ADCCON0 &= 0XF0;
  44   1        eleccycle -= 1;
  45   1        if(times == 1)
  46   1          ADCCON0 |= 0X03 + BEMF_DCT_Params[eleccycle][DC_CH];
  47   1        else
  48   1          ADCCON0 |= 0X03 + BEMF_DCT_Params[eleccycle][BEMF_CH];
  49   1        ADCDLY = 0;
  50   1        ADCCON2 = 0x00;
  51   1        ADCCON0 |= 0X40;  //start adc
  52   1      } 
  53          
  54          
C51 COMPILER V9.59.0.0   BLDC_SENSORLESS                                                   02/23/2019 21:02:51 PAGE 2   

  55          unsigned char BEMF_Calculate(unsigned char eleccycle) using 1
  56          { 
  57   1        bit bemf_cmp = 0;
  58   1        eleccycle -= 1; 
  59   1        DCBUS_Voltage = Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][DC_CH]];
  60   1        if(BEMF_DCT_Params[eleccycle][SLOPE])
  61   1        {
  62   2          bemf_cmp = Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]] < (DCBUS_Voltage >> 1);
  63   2          if(Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]] < (DCBUS_Voltage >> MagDecayPulseDct
             -))
  64   2            BEMF_Slope_Count = 0;
  65   2        }
  66   1        else
  67   1        {
  68   2          bemf_cmp = Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]] > (DCBUS_Voltage >> 1); 
  69   2          if(Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]] > (DCBUS_Voltage - (DCBUS_Voltage >>
             - MagDecayPulseDct)))
  70   2            BEMF_Slope_Count = 0;
  71   2        }
  72   1        if(!bemf_cmp && (BEMF_Slope_Count <= (MagDecayPulseCnt >> 1)))
  73   1          BEMF_Slope_Count++;
  74   1        if(bemf_cmp && (BEMF_Slope_Count >= (MagDecayPulseCnt >> 1)) && (BEMF_Slope_Count <= MagDecayPulseCnt))
  75   1          BEMF_Slope_Count++;
  76   1        if(PreviousBEMF_CH != BEMF_DCT_Params[eleccycle][BEMF_CH])
  77   1          BEMF_Slope_Count = 0;
  78   1        PreviousBEMF_CH = BEMF_DCT_Params[eleccycle][BEMF_CH];
  79   1        PrevoiusBEMF_Value = Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]];
  80   1        if((BEMF_Slope_Count >= MagDecayPulseCnt) && bemf_cmp)
  81   1        {
  82   2          return 1;
  83   2        }
  84   1        return 0;
  85   1      }
  86          
  87          void BEMF_Gpio_ADCIN_Init()
  88          {
  89   1        P0M1 |= 0x70;
  90   1        P0M2 &= 0x8f;
  91   1        AINDIDS  |= 0x3E;
  92   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    347    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     29    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
