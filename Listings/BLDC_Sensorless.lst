C51 COMPILER V9.59.0.0   BLDC_SENSORLESS                                                   03/02/2019 14:43:25 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE BLDC_SENSORLESS
OBJECT MODULE PLACED IN .\Objects\BLDC_Sensorless.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE BLDC_Sensorless.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\BLDC_Sensorless.lst) TABS(2) OBJECT(.\Objects\BLDC_Sensorless.obj)

line level    source

   1          #include <N76E003.h>
   2          #include <BLDC_Sensorless.h>
   3          
   4          #define MagDecayPulseDct 3    //Magnent Decay Detect threshold
   5          #define MagDecayPulseCnt 4    //Maagnent Decay Detect Count
   6          
   7          #define PhaseSwitchCount 5
   8          
   9          unsigned int DCBUS_Voltage = 0;
  10          
  11          unsigned int data Phase_UVW_Voltage_ADC_Value[3];
  12          
  13          const unsigned char BEMF_DCT_Params[6][3] = {
  14            {0,2,0},
  15            {0,1,1},
  16            {1,0,0},
  17            {1,2,1},
  18            {2,1,0},
  19            {2,0,1},
  20          };
  21          
  22          #define DC_CH 0
  23          #define BEMF_CH 1
  24          #define SLOPE 2
  25          
  26          unsigned char data PreviousBEMF_CH;
  27          unsigned char data PrevoiusBEMF_Value;
  28          unsigned char data BEMF_Slope_Count;
  29          
  30          void Set_Phase_U_Voltage_ADC_Value(unsigned int i) using 1
  31          {
  32   1        Phase_UVW_Voltage_ADC_Value[0] = i;
  33   1      }
  34          void Set_Phase_V_Voltage_ADC_Value(unsigned int i) using 1
  35          {
  36   1        Phase_UVW_Voltage_ADC_Value[1] = i;
  37   1      }
  38          void Set_Phase_W_Voltage_ADC_Value(unsigned int i) using 1
  39          {
  40   1        Phase_UVW_Voltage_ADC_Value[2] = i;
  41   1      }
  42          
  43          void Start_BEMF_Detect_ADC(unsigned char eleccycle, unsigned char times, bit pwm_on_sense) using 1
  44          {
  45   1        if(pwm_on_sense)
  46   1          ADCCON1 = 0X01;
  47   1        else
  48   1          ADCCON1 = 0X03;
  49   1        ADCCON0 &= 0XF0;
  50   1        eleccycle -= 1;
  51   1        if(times == 1)
  52   1          ADCCON0 |= 0X03 + BEMF_DCT_Params[eleccycle][DC_CH];
  53   1        else
  54   1          ADCCON0 |= 0X03 + BEMF_DCT_Params[eleccycle][BEMF_CH];
C51 COMPILER V9.59.0.0   BLDC_SENSORLESS                                                   03/02/2019 14:43:25 PAGE 2   

  55   1        ADCDLY = 0;
  56   1        ADCCON2 = 0x00;
  57   1        if(pwm_on_sense)
  58   1          ADCCON0 |= 0X40;  //start adc
  59   1      } 
  60          
  61          
  62          unsigned char BEMF_Calculate(unsigned char eleccycle) using 1
  63          { 
  64   1        bit bemf_cmp = 0;
  65   1        eleccycle -= 1; 
  66   1        if(PreviousBEMF_CH == eleccycle)
  67   1        {
  68   2          DCBUS_Voltage = Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][DC_CH]];
  69   2          if(BEMF_DCT_Params[eleccycle][SLOPE])
  70   2          {
  71   3            bemf_cmp = Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]] < (DCBUS_Voltage >> 1);
  72   3            if(Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]] < (DCBUS_Voltage >> MagDecayPulseDc
             -t))
  73   3              BEMF_Slope_Count = 0;
  74   3          }
  75   2          else
  76   2          {
  77   3            bemf_cmp = Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]] > (DCBUS_Voltage >> 1); 
  78   3            if(Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]] > (DCBUS_Voltage - (DCBUS_Voltage >
             -> MagDecayPulseDct)))
  79   3              BEMF_Slope_Count = 0;
  80   3          }
  81   2          if(!bemf_cmp && (BEMF_Slope_Count <= (MagDecayPulseCnt >> 1)))
  82   2            BEMF_Slope_Count++;
  83   2          if(bemf_cmp && (BEMF_Slope_Count >= (MagDecayPulseCnt >> 1)) && (BEMF_Slope_Count <= MagDecayPulseCnt))
  84   2            BEMF_Slope_Count++;
  85   2          PrevoiusBEMF_Value = Phase_UVW_Voltage_ADC_Value[BEMF_DCT_Params[eleccycle][BEMF_CH]];  
  86   2          if(bemf_cmp)
  87   2          if((BEMF_Slope_Count >= MagDecayPulseCnt) && bemf_cmp)
  88   2          {
  89   3        //    P07 = 1;
  90   3            return 1;
  91   3          }
  92   2        }
  93   1        else
  94   1        { 
  95   2          BEMF_Slope_Count = 0;
  96   2          
  97   2          PreviousBEMF_CH = eleccycle;
  98   2        }
  99   1      //  P07 = 0;
 100   1        return 0;
 101   1      }
 102          
 103          void BEMF_Gpio_ADCIN_Init()
 104          {
 105   1        P0M1 |= 0x70;
 106   1        P0M2 &= 0x8f;
 107   1        AINDIDS  |= 0x3E;
 108   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    363    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
C51 COMPILER V9.59.0.0   BLDC_SENSORLESS                                                   03/02/2019 14:43:25 PAGE 3   

   PDATA SIZE       =   ----    ----
   DATA SIZE        =     29    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
